name: Release

on:
    push:
        tags:
            - "v*.*.*"

env:
    MSRV: "1.87"

jobs:
    create-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true

    build-artifacts:
        runs-on: ${{ matrix.os }}
        permissions:
            contents: write
        needs: create-release
        strategy:
            matrix:
                include:
                    - target: aarch64-apple-darwin
                      os: macos-15
                    - target: x86_64-apple-darwin
                      os: macos-14
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-24.04-arm64
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-24.04
        steps:
            - name: Checkout Sources
              uses: actions/checkout@v4

            - name: Install MSRV Toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.MSRV }}

            - name: Setup Cache
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "build"

            - name: Add Target
              run: rustup target add ${{ matrix.target }}

            - name: Build Release Binary
              run: cargo build --release --target ${{ matrix.target }}

            - name: Package Artifact
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/doto dist/
                  tar -czf doto-${{ github.ref_name }}-${{ matrix.target }}.tar.gz -C dist doto

            - name: Upload Release Asset
              uses: softprops/action-gh-release@v2
              with:
                  files: doto-${{ github.ref_name }}-${{ matrix.target }}.tar.gz

    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        needs: build-artifacts
        steps:
            - name: Checkout Sources
              uses: actions/checkout@v4

            - name: Install MSRV Toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.MSRV }}

            - name: Setup Cache
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "build"

            - name: Publish doto-core
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p doto-core --locked

            - name: Publish doto
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p doto --locked
