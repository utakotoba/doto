name: Rust CI
on:
    push:
        branches:
            - main
        paths-ignore:
            - "**.md"
            - "bench/**"
    pull_request:
    merge_group:
    schedule:
        - cron: "00 04 * * 0"

env:
    MSRV: "1.87"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    check:
        name: Check on MSRV
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Sources
              uses: actions/checkout@v6

            - name: Install MSRV Toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.MSRV }}

            - name: Setup Cache
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "build"

            - name: Code Check
              run: cargo check --locked --workspace --all-targets --all-features

    lint:
        name: Lint Code
        needs: check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Sources
              uses: actions/checkout@v6

            - name: Install MSRV Toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.MSRV }}
                  components: rustfmt, clippy

            - name: Read Cache
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "build"

            - name: Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Cargo Doc Check
              run: cargo doc --no-deps --workspace --document-private-items
              env:
                  RUSTDOCFLAGS: -D warnings

    test:
        name: Unit Test
        needs: check
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        timeout-minutes: 15
        env:
            RUST_BACKTRACE: 1
        steps:
            - name: Checkout Sources
              uses: actions/checkout@v6

            - name: Install MSRV Toolchain
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.MSRV }}

            - name: Read Cache
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "build"

            - name: Cargo Test
              run: cargo test --workspace --all-targets --all-features
